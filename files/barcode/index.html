<!DOCTYPE html>
<html>
<head>
  <meta charset='UTF-8'>
  <title>HTML5 Barcode Scanner</title>

  <style>
    canvas {
      border: 1px solid #000;
      height: 256px;
      width: 256px;
    }
  </style>
</head>
<body>
  <video width="256" height="256" autoplay>No video tag support.</video>
  <canvas></canvas>

  <script>
    /* These are made available in the global scope of the application. */
    var stream, video;

    navigator.getUserMedia = ( navigator.getUserMedia ||
                               navigator.webkitGetUserMedia ||
                               navigator.mozGetUserMedia ||
                               navigator.msGetUserMedia);

    if (navigator.getUserMedia) {
      navigator.getUserMedia(
        {
          video: true,
          audio: false
        },

        function onSuccess(localMediaStream) {
          stream = localMediaStream;
          video = document.querySelector('video');

          video.addEventListener('loadedmetadata',function onloadedmetadata() {
            video.removeEventListener('loadedmetadata', onloadedmetadata, false);
            video.play();

            /* We can now use the video to initialize our canvas. */
            initCanvas();
          }, false);

          video.src = window.URL.createObjectURL(stream);
        },

        function onFailure(err) {
          /**
          * LocalMediaStream was not available. This could
          * be due to another application already having
          * a lock on the camera.
          */
          console.log("The following error occured: " + err);
        }
      );


      /* These are made available in the global scope of the application. */
      var canvas, context, vx, vy, vw, vh, cx, cy, cw, ch;

      // Previously Defined:
      // video

      function initCanvas() {
        canvas = document.querySelector('canvas');
        canvas.width = 256;
        canvas.height = 256;

        context = canvas.getContext('2d');

        vx = 0;
        vy = 0;
        vw = video.videoWidth;
        vh = video.videoHeight;
        cx = 0;
        cy = 0;
        cw = canvas.width;
        ch = canvas.height;
      }


      /* These are made available in the global scope of the application. */
      var worker;

      function initWorkers() {
        worker = new Worker('DecoderWorker.js');

        worker.onmessage = function (message) {
          if (message.data.success === true) {
            /* Take action here. */
          }

          context.drawImage(video, vx, vy, vw, vh, cx, cy, cw, ch);
        };
      }


      /* These are made available in the global scope of the application. */
      var scanningTimeout;

      // Previously Defined:
      // video, context, workers, vx, vy, vw, vh, cx, cy, cw, ch

      function startScanning(timeout) {
        scanningTimeout = window.setTimeout(function () {
          context.drawImage(video, vx, vy, vw, vh, cx, cy, cw, ch);
          worker.postMessage(context.getImageData(0,0, cw, ch));
        }, timeout || 0);
      }
    } else {
      alert('No support for getUserMedia!');
    }
  </script>
</body>
</html>
