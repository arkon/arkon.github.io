<!DOCTYPE html>
<html>
<head>
  <meta charset='UTF-8'>
  <title>HTML5 Barcode Scanner</title>

  <style>
    video {
      border: 1px solid red;
      width: 300px;
    }

    canvas {
      border: 1px solid green;
      width: 300px;
    }
  </style>
</head>
<body>
  <video width="300" autoplay>No video tag support.</video>
  <canvas></canvas>

  <script>
    /* These are made available in the global scope of the application. */
    var stream, video;

    navigator.getUserMedia = ( navigator.getUserMedia ||
                               navigator.webkitGetUserMedia ||
                               navigator.mozGetUserMedia ||
                               navigator.msGetUserMedia);

    if (navigator.getUserMedia) {
      navigator.getUserMedia(
        {
          video: true,
          audio: false
        },

        function onSuccess(localMediaStream) {
          stream = localMediaStream;
          video = document.querySelector('video');

          video.addEventListener('loadedmetadata',function onloadedmetadata() {
            video.removeEventListener('loadedmetadata', onloadedmetadata, false);
            video.play();

            /* We can now use the video to initialize our canvas. */
            initCanvas();
          }, false);

          video.src = window.URL.createObjectURL(stream);
        },

        function onFailure(err) {
          /**
          * LocalMediaStream was not available. This could
          * be due to another application already having
          * a lock on the camera.
          */
          console.log("The following error occured: " + err);
        }
      );


      /* These are made available in the global scope of the application. */
      var canvas, context, vx, vy, vw, vh, cx, cy, cw, ch;

      // Previously Defined:
      // video

      function initCanvas() {
        canvas = document.querySelector('canvas');

        context = canvas.getContext('2d');

        video.addEventListener('loadeddata', findVideoSizeEvent);

        vx = 0;
        vy = 0;
        cx = 0;
        cy = 0;
      }

      function findVideoSizeEvent(event) { findVideoSize(); }

      function findVideoSize() {
        if (video.videoWidth > 0 && video.videoHeight > 0) {
          video.removeEventListener('loadeddata', findVideoSize);

          vw = video.videoWidth;
          vh = video.videoHeight;

          canvas.width = vw;
          canvas.height = vh;

          cw = canvas.width;
          ch = canvas.height;

          initWorkers();
        } else {
          setTimeout(findVideoSize, 200);
        }
      }


      /* These are made available in the global scope of the application. */
      var worker;

      function initWorkers() {
        worker = new Worker('DecoderWorker.js');

        startScanning(500);

        worker.onmessage = function(message) {
          if (message.data.success === true) {
            /* Take action here. */
            console.log('success');
          } else {
            console.log('failure');
          }

          context.drawImage(video, vx, vy, vw, vh, cx, cy, cw, ch);
        };
      }


      /* These are made available in the global scope of the application. */
      var scanningTimeout;

      function startScanning(timeout) {
        scanningTimeout = window.setInterval(function () {
          context.drawImage(video, vx, vy, vw, vh, cx, cy, cw, ch);
          worker.postMessage(
            {
              ImageData: context.getImageData(0,0, cw, ch).data,
              Width: cw,
              Height: ch,
              cmd: 'normal',
              Decode: ['Code128'],
              LowLight: true
            }
          );
        }, timeout || 0);
      }
    } else {
      alert('No support for getUserMedia!');
    }
  </script>
</body>
</html>
